{
    "fullUrl":"urn:uuid:{{ ID }}",
    "resource":{
        "resourceType": "Patient",
        "id":"{{ ID }}",
        "meta":
        {
            "profile":
            [
                "http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient",
            ],
        },
        "identifier":
        [
            {% assign ids = patientRole.id | to_array -%}
            {% for id in ids -%}
                {% include 'DataType/Identifier', Identifier: id -%}
            {% endfor -%}
        ],
        "name":
        [
            {% assign names = patientRole.patient.name | to_array -%}
            {% for name in names -%}
            { {% include 'DataType/HumanName', HumanName: name -%} },
            {% endfor -%}
        ],
        "birthDate":"{{ patientRole.patient.birthTime.value | add_hyphens_date }}",
        {% assign deceasedDateValue = patientRole.patient['sdtc_deceasedTime'].value %}
        {% if deceasedDateValue %}
            "deceasedDate": "{{ deceasedDateValue | add_hyphens_date }}",
        {% else %}
            "deceasedBoolean": false,
        {% endif %}
        "gender":"{{ patientRole.patient.administrativeGenderCode.code | get_property: 'ValueSet/Gender' }}",
        "extension":
        [
            { {% include 'Extension/Race', Race: patientRole.patient -%} },
            { {% include 'Extension/Ethnicity', Ethnicity: patientRole.patient -%} },
            { {% include 'Extension/Religion', patient: patientRole.patient -%}},
            {%- assign birthSexObs = '' -%}
            {% for entry in SOCIALOBS -%}
                {% assign firstTemplate = entry.observation.templateId | to_array | first -%}
                {% if firstTemplate.root == '2.16.840.1.113883.10.20.34.3.45' or entry.observation.code.code == '76691-5' -%}
                    { {% include 'Extension/GenderIdentity', gendIdOb: entry.observation -%} },
                {% elsif firstTemplate.root == '2.16.840.1.113883.10.20.15.2.3.48' -%}
                    { {% include 'Extension/TribalAffiliation', tribeAOb: entry.observation -%} },
                {% elsif entry.observation.code.code == '76689-9' and birthSexObs == blank -%}
                    {% assign birthSexObs = entry.observation -%}
                {% endif -%}
            {% endfor -%}
            { {% include 'Extension/BirthSex', birthSObs: birthSexObs -%} },
        ],
        "address":
        [
            {% assign addrs = patientRole.addr | to_array -%}
            {% for addr in addrs -%}
            { {% include 'DataType/Address', Address: addr -%} },
            {% endfor -%}
        ],
        "maritalStatus": {
            {% include 'DataType/CodeableConcept', CodeableConcept: patientRole.patient.maritalStatusCode, minCardinality: 0 -%}
        },
        "telecom":
        [
            {% assign telecoms = patientRole.telecom | to_array -%}
            {% for telecom in telecoms -%}
            { {% include 'DataType/ContactPoint', ContactPoint: telecom -%} },
            {% endfor -%}
        ],
        "contact": [
        {% for participant in participants -%}
            {% assign contact = participant.associatedEntity -%}
            {% if contact.classCode == "ECON" -%}
                {
                    "relationship": [
                        { {% include 'DataType/CodeableConcept', CodeableConcept: contact.code, minCardinality: 0 -%} }
                    ],
                    {% assign name = contact.associatedPerson.name | to_array | first-%}
                    "name": { {% include 'DataType/HumanName', HumanName: name -%} },
                    "telecom": [
                        {% assign telecoms = contact.telecom | to_array -%}
                        {% for telecom in telecoms -%}
                        { {% include 'DataType/ContactPoint', ContactPoint: telecom -%} },
                        {% endfor -%}
                    ],
                    {% assign addr = contact.addr | to_array | first -%}
                    "address": { {% include 'DataType/Address', Address: addr -%} },
                },
            {% endif -%}
        {% endfor -%}
        ],
        "communication":
        [
            {% assign languageCommunications = patientRole.patient.languageCommunication | to_array -%}
            {% for languageCommunication in languageCommunications -%}
                {%- assign langCode       = languageCommunication.languageCode.code | downcase | strip | default: '' -%}
                {%- assign mappedCode     = langCode | get_property: 'ValueSet/Language', 'code' -%}
                {%- assign mappedDisplay  = langCode | get_property: 'ValueSet/Language', 'display' -%}
                {%- assign cdaNullFlavor  = languageCommunication.languageCode.nullFlavor | upcase | strip | default: '' -%}
                {%- assign nullFlavorToUse = cdaNullFlavor | default: 'OTH' -%}
            {
                "language":
                {
                    {%- if mappedCode != blank -%}
                        "coding": [ { "system":"urn:ietf:bcp:47", "code":"{{ mappedCode }}", "display":"{{ mappedDisplay }}" } ]
                    {%- else -%}
                        "extension": [ {% include 'Extension/DataAbsentReason', nullFlavor: nullFlavorToUse -%} ],
                        "text": "{{ languageCommunication.languageCode.displayName | default: languageCommunication.languageCode.code }}"
                    {%- endif -%}
                },
                {% if languageCommunication.preferenceInd.value -%}
                    "preferred": {{ languageCommunication.preferenceInd.value }},
                {% endif -%}
                "extension":
                [
                    { {% include 'Extension/PatientProficiency', modeCode: languageCommunication.modeCode, proficiencyLevelCode: languageCommunication.proficiencyLevelCode -%} },
                ],
            },
            {% endfor -%}
        ],
    },
},
