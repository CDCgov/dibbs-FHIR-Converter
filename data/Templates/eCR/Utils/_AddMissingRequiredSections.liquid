{% comment %} Checks and adds missing required sections in the Composition {% endcomment %}
{% comment %} See https://hl7.org/fhir/us/ecr/2.1.2/StructureDefinition-eicr-composition.html for list of required Composition sections {% endcomment %}
{% comment %} For template OIDs, see HL7 CDA® R2 Implementation Guide: Public Health Case Report – the Electronic Initial Case Report (eICR) Release 2, STU Release 3.1 - US Realm {% endcomment %}

{% assign requiredSections = "2.16.840.1.113883.10.20.22.2.12|1.3.6.1.4.1.19376.1.5.3.1.1.13.2.1|1.3.6.1.4.1.19376.1.5.3.1.3.4|2.16.840.1.113883.10.20.22.2.5.1|2.16.840.1.113883.10.20.22.2.38|2.16.840.1.113883.10.20.22.2.3.1|2.16.840.1.113883.10.20.22.2.17" | split: "|" %}
{% assign missingSections = "" %}

{% for req in requiredSections %}
  {% unless templatesInComp contains req %}
    {% assign missingSectionIds = missingSections | append: req | append: "|" %}
  {% endunless %}
{% endfor %}
{% assign missingSectionIds = missingSectionIds | split: "|" %}

{% for missingSectionId in missingSectionIds %}
  {
    "code": {
      "coding": [
        {
          "system": "http://loinc.org",
          {%- include 'ValueSet/CompositionSectionCode' id: missingSectionId -%}
        }
      ]
    },
    "text": {
      "status": "empty",
      "div": "{{ "" | to_xhtml | clean_string_from_tabs | escape_special_chars }}",
    }
  },
{% endfor %}