{
    "fullUrl":"urn:uuid:{{ID}}",
    "resource":{
        "resourceType": "Immunization",
        "id":"{{ID}}",
        "identifier":
        [
            {% assign ids = immunization.id | to_array -%}
            {% for id in ids -%}
                {% include 'DataType/Identifier' Identifier: id -%}
            {% endfor -%}
        ],

        {% assign entryRelationships = immunization.entryRelationship | to_array -%}
        {% assign statusReasonObs = entryRelationships | nested_where: "observation.templateId.root", "2.16.840.1.113883.10.20.22.4.53" | first %}
        "statusReason": { {% include 'DataType/CodeableConcept' CodeableConcept: statusReasonObs.observation.code -%} },
        "protocolApplied": [
            {% for entryRelationship in entryRelationships -%}
                {
                    {% if entryRelationship.typeCode == "COMP" and entryRelationship.sequenceNumber.value -%}
                        "doseNumberPositiveInt": {{ entryRelationship.sequenceNumber.value }},
                    {% endif %}
                },
            {% endfor %}
        ],
        {% comment %} Immunization only supports DateTime or String {% endcomment %}
        {% if immunization.effectiveTime.low -%}
            "occurrenceDateTime": "{{ immunization.effectiveTime.low.value | format_as_date_time }}",
        {% elsif immunization.effectiveTime.value -%}
            "occurrenceDateTime": "{{ immunization.effectiveTime.value | format_as_date_time }}",
        {% else -%}
            "occurrenceString": "Unknown",
        {% endif -%}

        {% comment %} Sometimes vaccine names exist as a reference to a separate html table in the narrative text {% endcomment %}
        {% comment %} This chunk of logic grabs the passed in table and splits the string to return the vaccine name substring {% endcomment %}
        {% comment %} It also chops out common wrapping tags that could mess things up e.g. <content> {% endcomment %}
        {% assign refId = immunization.text.reference.value | remove: '#' %}
        {% assign startTag = 'ID="' | append: refId | append: 'Name"' %}
        {% assign afterId = immunizationsText._innerText | split: startTag | last %}
        {% assign normalized = afterId | replace: '/>', '>' %}
        {% assign parts = normalized | split: '>' %}
        {% assign namePart = parts[1] %}
        {% assign vaccineDisplay = namePart | split: '<' | first | strip%}

        {% assign manufacturedProduct = immunization.consumable.manufacturedProduct %}

        "vaccineCode": {
        {% include 'DataType/CodeableConcept' CodeableConcept: manufacturedProduct.manufacturedMaterial.code -%}
        {% if vaccineDisplay -%}
            ,"text": "{{ vaccineDisplay }}"
        {% endif -%}
        },
        "lotNumber":"{{ manufacturedProduct.manufacturedMaterial.lotNumberText._ }}",
        {% assign manufacturerId = manufacturedProduct.manufacturerOrganization | to_json_string | generate_uuid -%}
        {% assign fullManufacturerId = manufacturerId | prepend: 'Organization/' -%}
        "manufacturer": {
            "reference": "{{ fullManufacturerId }}",
        },

        {% if immunization.statusCode.code -%}
            "status":"{{immunization.statusCode.code | get_property: 'ValueSet/ImmunizationStatus' }}",
        {% else -%}
            "status":"completed",
        {% endif -%}
        "primarySource": true,
        "route":{ {% include 'DataType/CodeableConcept' CodeableConcept: immunization.routeCode -%}},
        "site":{ {% include 'DataType/CodeableConcept' CodeableConcept: immunization.approachSiteCode -%} },
    },
},
